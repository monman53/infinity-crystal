<!DOCTYPE html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0">
    <title>Infinity Crystal</title>

    <style>
        #main-canvas {
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
</head>

<body>
    <canvas id="main-canvas"></canvas>
</body>

<!-- Vertex shader -->
<script id="vs" type="x-shader/x-vertex">#version 300 es

in vec4 position;

void main() {
    gl_Position = position;
}
</script>

<!-- Fragment shader -->
<script id="fs" type="x-shader/x-fragment">#version 300 es
precision highp float;
out vec4 outColor;
void main(void){
    outColor = vec4(1.0, 0.0, 0.0, 0.5);
}
</script>

<!-- Main script -->
<script>
    // Window size
    let width = 0;
    let height = 0;
    const resize = () => {
        width = window.innerWidth;
        height = window.innerHeight;
    }
    resize();
    // window.addEventListener('resize', resize);

    // Canvas
    const canvas = document.getElementById('main-canvas');
    canvas.width = width;
    canvas.height = height;

    //--------------------------------
    // WebGL support functions
    //--------------------------------
    const createShader = (gl, type, src) => {
        const shader = gl.createShader(type)
        if (!shader) {
            throw new Error()
        }
        gl.shaderSource(shader, src)
        gl.compileShader(shader)
        if (!gl.getShaderParameter(shader, gl.COMPILE_STATUS)) {
            throw new Error(gl.getShaderInfoLog(shader));
        }
        return shader
    }

    function createProgram(gl, shaderSources) {
        const program = gl.createProgram()
        if (!program) {
            throw new Error()
        }
        [gl.VERTEX_SHADER, gl.FRAGMENT_SHADER].forEach((type, ndx) => {
            const shader = createShader(gl, type, shaderSources[ndx])
            if (!shader) {
                throw new Error()
            }
            gl.attachShader(program, shader)
        })
        gl.linkProgram(program)
        if (!gl.getProgramParameter(program, gl.LINK_STATUS)) {
            throw new Error(gl.getProgramInfoLog(program));
        }
        return program
    }

    // Dummy clip for texture computation
    const createDummyClipVA = (gl, program) => {
        const buffer = gl.createBuffer()
        gl.bindBuffer(gl.ARRAY_BUFFER, buffer)
        gl.bufferData(
            gl.ARRAY_BUFFER,
            new Float32Array([-1, -1, 1, -1, -1, 1, -1, 1, 1, -1, 1, 1]), // Rectangle
            gl.STATIC_DRAW
        )
        const vao = gl.createVertexArray()
        gl.bindVertexArray(vao)

        // setup our attributes to tell WebGL how to pull
        // the data from the buffer above to the position attribute
        const positionLoc = gl.getAttribLocation(program, 'position')
        gl.enableVertexAttribArray(positionLoc)
        gl.vertexAttribPointer(
            positionLoc,
            2, // size (num components)
            gl.FLOAT, // type of data in buffer
            false, // normalize
            0, // stride (0 = auto)
            0 // offset
        )

        return vao
    }

    const gl = canvas.getContext('webgl2');

    const vsText = document.getElementById('vs').text;
    const fsText = document.getElementById('fs').text;

    const program = createProgram(gl, [vsText, fsText]);

    const drawVA = createDummyClipVA(gl, program);

    gl.useProgram(program)

    gl.bindVertexArray(drawVA)
    gl.viewport(0, 0, width, height)

    gl.clearColor(0, 0, 0, 1)
    gl.clear(gl.COLOR_BUFFER_BIT)

    gl.drawArrays(gl.TRIANGLES, 0, 6)

    console.log(program)
</script>